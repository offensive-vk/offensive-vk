name: ‚ö†Ô∏è Report Workflow Failures

on:
  workflow_run:
    workflows:
      - '**'
      # - 'üõ´ Auto Update Dependencies'
      # - '‚õΩ Automated Repo Statistics'
      # - '‚öíÔ∏è Automated Image Testing'
      # - '‚úÖ Automated Linter'
      # - 'ü§ñ Automated Issue - Hamster üêπ'
      # - 'üè∑Ô∏è Automated Label - Hamster üêπ'
      # - 'ü§ñ Automated Pull Request - Hamster üêπ'
      # - 'üóÉÔ∏è Automated Project - Hamster üêπ'
      # - '‚õÖ Docker - Build Image'
      # - 'ü¶Ö Gitlab - Mirror Sync'
      # - 'üêç Generate Snake Contribution GIF'
      # - '‚ú® Generate Contribution Pattern'
      # - '‚≠ê Generate Starred Repo List'
      # - 'üå®Ô∏è Publish Multi Platform Docker Images'
    types: [completed]
  workflow_dispatch:

jobs:
  monitor-workflows:
    name: Monitor Workflows
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      github-token: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Get Failed Jobs
        id: get-failed-jobs
        run: |
          run_id=${{ github.event.workflow_run.id }}
          failed_jobs=$(gh api repos/${{ github.repository }}/actions/runs/$run_id/jobs --jq \
            '.jobs | map(select(.conclusion == "failure") | .name) | join(", ")')

          echo "failed_jobs=$failed_jobs" >> $GITHUB_ENV

      - name: Create Issue for Failed Jobs
        if: ${{ env.failed_jobs != '' }}
        uses: dacbd/create-issue-action@main
        with:
          token: ${{ secrets.BOT_TOKEN }}
          title: |
            ${{ github.event.workflow.name }} is reporting errors.
          assignees: TheHamsterBot
          labels: automated,bot,hamster,issue,github-action,reporter
          body: |
            > [!CAUTION]  
            > The workflow **${{ github.event.workflow_run.name }}** (ID: ${{ github.event.workflow_run.id }}) had failed jobs.  
              
            ## **Failed Jobs:**  
            - ${{ env.failed_jobs }}
            
            ## **Failure Details:**
            - Workflow Path: ${{ github.workflow_ref }}
            - Conclusion: ${{ github.event.workflow_run.conclusion }}  
            - Status Message: ${{ github.event.workflow_run.status_message || 'N/A' }}

            Thanks.
            $timestamp
            Your Hamster üêπ <code>PF78VAPPKLZ2</code>