name: 🔒 Check Modified Files

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  check-modified-files:
    name: Verify
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get list of modified files
        id: changed_files
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}
          git diff --name-only origin/${{ github.event.pull_request.base.ref }} > changed_files.txt

      - name: Get Head Commit Author
        id: get_committer
        run: |
          committer=$(git log -1 --pretty=format:'%an' HEAD)
          echo "committer=$committer" >> $GITHUB_ENV

      - name: Validate Modified Files
        id: validate_files
        run: |
          # Authorized users
          authorized_users="dependabot[bot] ${{ github.repository_owner }}"

          # Protected files and directories
          sensitive_files=$(cat << EOF
            .github/
            .devcontainer/
            .github/workflows/
            *.yml
            *.yaml
            Dockerfile
            EOF
          )

          # Load committer from environment
          committer=$committer
          echo "Committer: $committer"

          if [[ ! " $authorized_users " =~ " $committer " ]]; then
            echo "Unauthorized committer: $committer"
            unauthorized=false

            while IFS= read -r file; do
              for sensitive in $sensitive_files; do
                if [[ $file == $sensitive ]] || [[ $file == *"$sensitive" ]]; then
                  unauthorized=true
                  break 2
                fi
              done
            done < changed_files.txt

            if $unauthorized; then
              echo "Unauthorized modifications detected."
              echo "::set-output name=unauthorized::true"
              exit 1
            fi
          fi
          echo "::set-output name=unauthorized::false"

      - name: Comment on PR if unauthorized
        if: steps.validate_files.outputs.unauthorized == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pr_number=${{ github.event.pull_request.number }}
          comment_body="⚠️ **Unauthorized modifications detected.**\n\nOnly the repository owner or dependabot can modify sensitive files like workflows or Dockerfiles."

          curl -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/issues/$pr_number/comments \
            -d "{\"body\":\"$comment_body\"}"

      - name: Comment on PR if authorized
        if: steps.validate_files.outputs.unauthorized == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pr_number=${{ github.event.pull_request.number }}
          comment_body="✅ **All modifications are authorized.**\n\nThe changes were made by an authorized committer."

          curl -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/issues/$pr_number/comments \
            -d "{\"body\":\"$comment_body\"}"
