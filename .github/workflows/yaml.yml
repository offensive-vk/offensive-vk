name: ğŸ” Advanced YAML Verification

on:
  pull_request:
    branches: [master]

jobs:
  yaml:
    runs-on: ubuntu-latest
    name: YAML Job
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y yamllint
          pip install yq

      - name: ğŸ“„ Create yamllint Config (Disable `---` Checks)
        run: |
          cat <<EOL > .yamllint
          extends: default
          rules:
            document-start: disable
            document-end: disable
          EOL

      - name: ğŸ“ YAML Lint Check
        run: |
          echo "ğŸ” Running yamllint..."
          yamllint -c .yamllint . --strict || (echo "âŒ YAML Lint Failed!")
          echo "âœ… YAML Lint Passed!"

      - name: ğŸ§ Required Fields Check
        run: |
          echo "ğŸ” Checking required fields..."
          missing_files=""
          for file in $(find . -name "*.yaml" -o -name "*.yml"); do
            for field in "name" "on" "jobs"; do
              if ! yq eval ". | has(\"$field\")" "$file" > /dev/null; then
                echo "âŒ Missing '$field' in $file"
                missing_files="$missing_files\n$file (missing $field)"
              fi
            done
          done
          if [ -n "$missing_files" ]; then
            echo -e "âš ï¸ The following files are missing required fields:$missing_files"
            exit 1
          fi
          echo "âœ… All YAML files have the required fields!"

      - name: ğŸ”„ ASCII Progress Bar (Just for Fun)
        run: |
          echo -n "Processing YAML files: "
          for i in {1..10}; do
            echo -n "â–ˆ"
            sleep 0.2
          done
          echo " âœ… Done!"

      - name: ğŸ“Š YAML Stats Report
        run: |
          total_files=$(find . -name "*.yaml" -o -name "*.yml" | wc -l)
          total_lines=$(find . -name "*.yaml" -o -name "*.yml" | xargs cat | wc -l)
          echo "ğŸ“‚ Total YAML Files: $total_files"
          echo "ğŸ“œ Total Lines in YAML: $total_lines"

      - name: ğŸš€ Auto-Comment on PR if Issues Found
        if: failure()
        uses: thollander/actions-comment-pull-request@v2
        with:
          message: "âš ï¸ YAML verification failed! Please check the errors in the GitHub Actions logs."
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
