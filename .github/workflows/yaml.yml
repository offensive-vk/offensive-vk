name: 🔏 Advanced YAML Verification

on:
  pull_request:
    branches: [master]

jobs:
  yaml:
    runs-on: ubuntu-latest
    name: YAML Job
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y yamllint
          pip install yq

      - name: 📄 Create yamllint Config (Disable `---` Checks)
        run: |
          cat <<EOL > .yamllint
          extends: default
          rules:
            document-start: disable
            document-end: disable
          EOL

      - name: 📝 YAML Lint Check
        run: |
          echo "🔍 Running yamllint..."
          yamllint -c .yamllint . --strict || (echo "❌ YAML Lint Failed!")
          echo "✅ YAML Lint Passed!"

      - name: 🧐 Required Fields Check
        run: |
          echo "🔍 Checking required fields..."
          missing_files=""
          for file in $(find . -name "*.yaml" -o -name "*.yml"); do
            for field in "name" "on" "jobs"; do
              if ! yq eval ". | has(\"$field\")" "$file" > /dev/null; then
                echo "❌ Missing '$field' in $file"
                missing_files="$missing_files\n$file (missing $field)"
              fi
            done
          done
          if [ -n "$missing_files" ]; then
            echo -e "⚠️ The following files are missing required fields:$missing_files"
            exit 1
          fi
          echo "✅ All YAML files have the required fields!"

      - name: 🔄 ASCII Progress Bar (Just for Fun)
        run: |
          echo -n "Processing YAML files: "
          for i in {1..10}; do
            echo -n "█"
            sleep 0.2
          done
          echo " ✅ Done!"

      - name: 📊 YAML Stats Report
        run: |
          total_files=$(find . -name "*.yaml" -o -name "*.yml" | wc -l)
          total_lines=$(find . -name "*.yaml" -o -name "*.yml" | xargs cat | wc -l)
          echo "📂 Total YAML Files: $total_files"
          echo "📜 Total Lines in YAML: $total_lines"

      - name: 🚀 Auto-Comment on PR if Issues Found
        if: failure()
        uses: thollander/actions-comment-pull-request@v2
        with:
          message: "⚠️ YAML verification failed! Please check the errors in the GitHub Actions logs."
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
