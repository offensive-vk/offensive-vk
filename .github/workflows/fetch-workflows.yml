name: ğŸ›œ Status - Workflows

on:
  push:
    branches: ['**']
    tags: ['**']
  pull_request:
    branches: ['**']
  workflow_dispatch:

env:
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  fetch-workflows:
    name: ğŸŒ Fetch Workflows
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ¤– Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“Š Fetch Workflow Statuses
        id: fetch-status
        run: |
          # Fetch all workflows using gh CLI
          gh workflow list --all --json name,id,state,createdAt,updatedAt > workflows.json

          # Parse counts
          total=$(jq '. | length' workflows.json)
          running=$(jq '[.[] | select(.state == "in_progress")] | length' workflows.json)
          successful=$(jq '[.[] | select(.state == "completed")] | length' workflows.json)

          # Output all the workflows
          workflows=$(cat workflows.json)

          echo "::notice::There are total $total workflows, $running running, and $successful completed."

          # Export workflow counts as environment variables
          echo "TOTAL_WORKFLOWS=$total" >> $GITHUB_ENV
          echo "RUNNING_WORKFLOWS=$running" >> $GITHUB_ENV
          echo "SUCCESSFUL_WORKFLOWS=$successful" >> $GITHUB_ENV
          echo "WORKFLOWS_OUTPUT=$workflows" >> $GITHUB_ENV

  comment-pr:
    name: ğŸ’¬ Comment on Pull Request
    needs: fetch-workflows
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ—£ï¸ Add PR Comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ### ğŸ“ PR Comment
            Hi there! Here's the current status of the workflows:
            - **Total Workflows:** ${{ env.TOTAL_WORKFLOWS }}
            - **Running Workflows:** ${{ env.RUNNING_WORKFLOWS }}
            - **Successful Workflows:** ${{ env.SUCCESSFUL_WORKFLOWS }}

            ### ğŸ”— All Workflows
            ```
            ${{ env.WORKFLOWS_OUTPUT }}
            ```

  comment-issue:
    name: ğŸ’¬ Comment on Issue
    needs: fetch-workflows
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ—£ï¸ Add Issue Comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            ### ğŸ“ Issue Comment
            Hello! Hereâ€™s the latest workflow status:
            - **Total Workflows:** ${{ env.TOTAL_WORKFLOWS }}
            - **Running Workflows:** ${{ env.RUNNING_WORKFLOWS }}
            - **Successful Workflows:** ${{ env.SUCCESSFUL_WORKFLOWS }}

            ### ğŸ”— All Workflows
            ```
            ${{ env.WORKFLOWS_OUTPUT }}
            ```