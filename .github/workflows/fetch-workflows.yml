name: 🛜 Status - Workflows

on:
  issues:
    types: [opened, edited, closed]
  pull_request:
    types: [opened, closed, synchronize]
  workflow_dispatch:
    inputs:
      number:
        description: 'Issue or PR Number to Execute Workflow'
        required: true
        default: '30000'

env:
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  fetch-workflows:
    name: Fetch Workflows
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install jq and gh
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          sudo apt-get install -y gh

      - name: 📊 Fetch Workflow Statuses
        id: fetch-status
        run: |
          gh workflow list --all --json name,id,state > workflows.json

          # Check if workflows.json is empty or invalid
          if [ ! -s workflows.json ]; then
            echo "Workflows could not be fetched or are unavailable." > workflows_summary.txt
            echo "total_workflows=0" >> $GITHUB_ENV
            echo "running_workflows=0" >> $GITHUB_ENV
            echo "successful_workflows=0" >> $GITHUB_ENV
            exit 0
          fi

          # Parse counts
          total=$(jq '. | length' workflows.json)
          running=$(jq '[.[] | select(.state == "in_progress")] | length' workflows.json)
          successful=$(jq '[.[] | select(.state == "completed")] | length' workflows.json)

          # Generate a terminal-style table summary
          echo "  Name                      | ID          | State       " > workflows_summary.txt
          echo "----------------------------|-------------|-------------" >> workflows_summary.txt
          jq -r '.[] | "  \(.name[:26]) | \(.id) | \(.state)       "' workflows.json >> workflows_summary.txt

          # Save outputs to step outputs
          echo "total_workflows=$total" >> $GITHUB_ENV
          echo "running_workflows=$running" >> $GITHUB_ENV
          echo "successful_workflows=$successful" >> $GITHUB_ENV
          echo "workflows_summary<<EOF" >> $GITHUB_ENV
          cat workflows_summary.txt >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV


      - name: 🗣️ Add Status Comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.inputs.number || github.event.pull_request.number || github.event.issue.number || 27614 }}
          body: |
            > [!TIP]
            > ## 📝 Workflow Status Update

            - **Manual Dispatch Number:** `${{ github.event.inputs.number }}`
            - **Total Workflows:** `${{ env.total_workflows }}`
            - **Running Workflows:** `${{ env.running_workflows }}`
            - **Successful Workflows:** `${{ env.successful_workflows }}`

            ### 📋 Workflows Summary (Terminal Style)
            ```
            ${{ env.workflows_summary }}
            ```

            Thank you,
            Your Hamster 🐹 <code>PF78VAPPKLZ2</code>
