name: ðŸ”’ Check Modified Files - Watchdog

on:
  pull_request_target:
    paths:
      - ".github/**"
      - ".devcontainer/**"
      - ".github/workflows/**"
      - "*.yml"
      - "*.yaml"
      - "Dockerfile"

jobs:
  check-sensitive-files:
    name: Check Sensitive Files
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the code
      - name: Checkout
        uses: actions/checkout@v4

      # Step 2: Retrieve Committer and Author Information
      - name: Get Committer and Author Info
        id: commit-info
        run: |
          echo "committer=${{ github.event.pull_request.head.user.login }}" >> $GITHUB_ENV
          echo "author=${{ github.event.pull_request.user.login }}" >> $GITHUB_ENV

      # Step 3: Validate the Modified Files and Users
      - name: Validate Changes
        id: validate-changes
        run: |
          # Authorized users
          committer="${{ env.committer }}"
          author="${{ env.author }}"
          repo_owner="${{ github.repository_owner }}"

          # Conditions for sensitive file modification
          if [[ "$committer" != "$repo_owner" && "$committer" != "dependabot[bot]" && "$author" != "$repo_owner" ]]; then
            echo "should_fail=true" >> $GITHUB_ENV
          else
            echo "should_fail=false" >> $GITHUB_ENV
          fi

      # Step 4: Post a Comment on the PR
      - name: Comment on the Pull Request
        uses: peter-evans/create-or-update-comment@v3
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ${{ steps.validate-changes.outputs.comment_body }}
          edit-mode: replace

      # Step 5: Fail if Unauthorized Changes are Detected
      - name: Fail if Unauthorized Changes
        if: ${{ env.should_fail == 'true' }}
        run: |
          echo "Unauthorized changes detected."
          exit 1
